---
title: Project
date: 2024-12-16
---


# Prepare
```{r warning = FALSE}
library(excessmort)
library(dplyr)
library(lubridate)
library(ggplot2)
head(puerto_rico_counts)
```


# Task 1

```{r}
population_summary <- puerto_rico_counts |>
  group_by(agegroup, sex) |>
  summarise(mean_population = mean(population, na.rm = TRUE))

print(population_summary)

ggplot(population_summary, aes(x = agegroup, y = mean_population, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Average Population Size by Age Group and Sex",
       x = "Age Group", y = "Average Population Size") +
  theme_minimal()
```
In the younger age group, under 14 years, male has higher proportion than female. This might be because of the notion that some of the family willingly prefer having boy baby than  girl. Besides, the sex ratio at born is around 105-107 boys versus 100 girls globally.

In the working age group, 20-49, female has higher proportion than male. This might be because male moving out for work or moving out for immigration. 
During the elder group, the proportion of female is still higher than that of male. This might be because the average age of female is higher than that of male. 




# Task 2

## Estimate expected mortality and a standard deviation for each week

```{r}
pre_2017_data <- puerto_rico_counts |>
  filter(date < as.Date("2017-01-01")) |>
  mutate(
    year = year(date),
    week_of_year = isoweek(date) # or week(date), but isoweek aligns ISO weeks
  )

# Compute weekly mortality per agegroup, sex, and week_of_year, aggregated by year
# sum over all days within each week_of_year-year combination
weekly_data <- pre_2017_data |>
  group_by(year, week_of_year, agegroup, sex) |>
  summarise(weekly_outcome = sum(outcome), .groups = 'drop')

# calculate the mean and SD of mortality per week_of_year, agegroup, and sex, 
# using all pre-2017 years as a baseline.
baseline_stats <- weekly_data |>
  group_by(agegroup, sex, week_of_year) |>
  summarise(
    mean_outcome = mean(weekly_outcome, na.rm = TRUE),
    sd_outcome = sd(weekly_outcome, na.rm = TRUE),
    .groups = 'drop'
  )

print("Baseline Weekly Statistics (Pre-2017):")
print(baseline_stats)

# Plotting a few selected age groups to show variation
ggplot(baseline_stats, aes(x = week_of_year, y = mean_outcome, color = sex)) +
  geom_line() +
  facet_wrap(~ agegroup, scales = "free_y") +
  labs(
    title = "Weekly Expected Mortality (Pre-2017) by Age Group and Sex",
    x = "Week of Year",
    y = "Mean Weekly Mortality"
  ) +
  theme_minimal()
```

## Combine data into bigger age groups
```{r}
# combining age groups:
# - Combine (0-4, 5-9, 10-14) into "0-14"
# - Combine (15-19,20-24,25-29,30-34,35-39) into "15-39"
# - Combine (40-44,45-49,50-54,55-59) into "40-59"
# - Combine (60-64,65-69,70-74) into "60-74"
# - Combine (75-79,80-84,85-Inf) into "75+"
combined_data <- pre_2017_data |>
  mutate(combined_agegroup = case_when(
    agegroup %in% c("0-4", "5-9", "10-14") ~ "0-14",
    agegroup %in% c("15-19", "20-24", "25-29", "30-34", "35-39") ~ "15-39",
    agegroup %in% c("40-44", "45-49", "50-54", "55-59") ~ "40-59",
    agegroup %in% c("60-64", "65-69", "70-74") ~ "60-74",
    agegroup %in% c("75-79", "80-84", "85-Inf") ~ "75+",
    TRUE ~ agegroup # If any leftover group, keep as is
  ))

# Aggregate daily data to weekly mortality by combined_agegroup, sex, year, and week_of_year
weekly_data_combined <- combined_data |>
  group_by(year, week_of_year, combined_agegroup, sex) |>
  summarise(weekly_outcome = sum(outcome), .groups = 'drop')

# Compute baseline means and sds per week_of_year, agegroup, sex
baseline_stats_combined <- weekly_data_combined |>
  group_by(combined_agegroup, sex, week_of_year) |>
  summarise(
    mean_outcome = mean(weekly_outcome, na.rm = TRUE),
    sd_outcome = sd(weekly_outcome, na.rm = TRUE),
    .groups = 'drop'
  )

print("Baseline Weekly Statistics With Combined Age Groups:")
print(baseline_stats_combined)

# Plot the combined groups
ggplot(baseline_stats_combined, aes(x = week_of_year, y = mean_outcome, color = sex)) +
  geom_line() +
  facet_wrap(~ combined_agegroup, scales = "fixed") +
  labs(
    title = "Weekly Expected Mortality (Pre-2017) by Combined Age Groups and Sex",
    x = "Week of Year",
    y = "Mean Weekly Mortality"
  ) +
  theme_minimal()
```

# Task 4

```{r}
maria <- make_date(2017, 9, 20)

q4_data <- puerto_rico_counts |>
  filter(between(year(date), 2017, 2018)) |>
  mutate(date = floor_date(date, week_start = wday(maria)-1, unit = "week")) 

weekly_counts <- q4_data |>
  group_by(date, sex, agegroup) |>
  summarize(outcome = sum(outcome,na.rm = TRUE), population = mean(population,na.rm = TRUE), n = n(),
            .groups = "drop")|>
  filter(n == 7) |>
  select(-n)|>
  mutate(week_of_year=epiweek(date))

excess_counts <- weekly_counts %>%
  left_join(baseline_stats, by = c('sex', 'agegroup','week_of_year'))|>
  mutate(excess_deaths=outcome-mean_outcome)



weekly_counts_summary = weekly_counts|>
  group_by(date) |>
  summarize(outcome = sum(outcome), 
            population = sum(population),
            .groups = "drop") 


```



```{r}
library(ggplot2)

# Plot the combined groups
ggplot(excess_counts, aes(x = date, y = excess_deaths, color = sex)) +
  geom_line() +
  facet_wrap(~ agegroup, scales = "fixed") +
  labs(
    title = "Weekly Expected Mortality (Pre-2017) by Combined Age Groups and Sex",
    x = "Week of Year",
    y = "Mean Weekly Mortality"
  ) +
    theme(
    axis.text.x = element_text(angle = 70, hjust = 1),  # Rotate week labels for better readability
    strip.text = element_text(size = 10, face = "bold"), # Adjust facet labels
    legend.position = "none"                            # Remove legend (optional)
  ) 

```











